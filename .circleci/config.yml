version: 2.1

orbs:
  node: circleci/node@5.0.0
  sonarcloud: sonarsource/sonarcloud@1.0.0

jobs:
  security-scan:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Run security audit
          command: |
            npm audit --audit-level moderate
            npm audit fix --force
      - run:
          name: Run Snyk security scan
          command: |
            npx snyk test --severity-threshold=high
      - run:
          name: Run ESLint security rules
          command: |
            npx eslint src --ext .ts,.tsx --config .eslintrc.security.js
      - run:
          name: Check for hardcoded secrets
          command: |
            npx detect-secrets scan --all-files --exclude-files package-lock.json
      - run:
          name: Run dependency vulnerability check
          command: |
            npx audit-ci --config audit-ci.json

  code-quality:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Run TypeScript type checking
          command: npx tsc --noEmit
      - run:
          name: Run ESLint
          command: npx eslint src --ext .ts,.tsx
      - run:
          name: Run Prettier
          command: npx prettier --check src
      - run:
          name: Run SonarQube analysis
          command: |
            npx sonar-scanner \
              -Dsonar.projectKey=secure-payments-portal \
              -Dsonar.organization=your-org \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$SONAR_TOKEN

  build-and-test:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Run tests
          command: npm test -- --coverage --watchAll=false
      - run:
          name: Build application
          command: npm run build
      - run:
          name: Test build integrity
          command: |
            # Check if build artifacts exist
            test -d build
            test -f build/index.html
            test -f build/static/js/*.js
            test -f build/static/css/*.css
      - run:
          name: Security headers test
          command: |
            # Test security headers in built application
            npx serve -s build -l 3000 &
            sleep 5
            curl -I http://localhost:3000 | grep -i "x-frame-options\|x-content-type-options\|strict-transport-security"
            pkill -f serve

  mobsf-scan:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - run:
          name: Install MobSF CLI
          command: |
            pip install mobsf-cli
      - run:
          name: Build application for MobSF scan
          command: npm run build
      - run:
          name: Run MobSF security scan
          command: |
            mobsf scan --file build/index.html --api_key $MOBSF_API_KEY

  scout-suite:
    docker:
      - image: cimg/python:3.9
    steps:
      - checkout
      - run:
          name: Install Scout Suite
          command: |
            pip install scout-suite
      - run:
          name: Run Scout Suite cloud security scan
          command: |
            scout aws --profile default --report-dir scout-reports

  database-security:
    docker:
      - image: cimg/postgres:13
    steps:
      - checkout
      - run:
          name: Install database security tools
          command: |
            apt-get update
            apt-get install -y postgresql-client
      - run:
          name: Run database security checks
          command: |
            # Check for common database vulnerabilities
            psql -h localhost -U postgres -d secure_payments_portal -c "
              SELECT * FROM pg_stat_activity WHERE state = 'active';
              SELECT * FROM pg_stat_user_tables;
            "

  deploy-staging:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Build for staging
          command: npm run build
      - run:
          name: Deploy to staging
          command: |
            # Deploy to staging environment
            echo "Deploying to staging environment..."
            # Add your deployment commands here

  deploy-production:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - node/install-packages
      - run:
          name: Build for production
          command: npm run build
      - run:
          name: Deploy to production
          command: |
            # Deploy to production environment
            echo "Deploying to production environment..."
            # Add your deployment commands here

workflows:
  security-pipeline:
    jobs:
      - security-scan
      - code-quality
      - build-and-test
      - mobsf-scan
      - scout-suite
      - database-security
      - deploy-staging:
          requires:
            - security-scan
            - code-quality
            - build-and-test
      - deploy-production:
          requires:
            - security-scan
            - code-quality
            - build-and-test
            - mobsf-scan
            - scout-suite
            - database-security
          filters:
            branches:
              only: main
