version: 2.1

jobs:
  test-and-sonar:
    docker:
      - image: cimg/node:20.17
    working_directory: ~/project
    steps:
      - checkout

      # Install dependencies
      - restore_cache:
          keys:
            - v1-frontend-deps-{{ checksum "frontend/package-lock.json" }}
            - v1-frontend-deps-
      - run:
          name: Install frontend deps
          command: |
            cd frontend
            npm ci
      - restore_cache:
          keys:
            - v1-api-deps-{{ checksum "api/package-lock.json" }}
            - v1-api-deps-
      - run:
          name: Install api deps
          command: |
            cd api
            npm ci
      - save_cache:
          key: v1-frontend-deps-{{ checksum "frontend/package-lock.json" }}
          paths:
            - frontend/node_modules
      - save_cache:
          key: v1-api-deps-{{ checksum "api/package-lock.json" }}
          paths:
            - api/node_modules

      # Tests with coverage
      - run:
          name: Frontend tests
          command: |
            cd frontend
            npm run test:ci || npm run test:ci --if-present
      - run:
          name: API tests
          command: |
            cd api
            npm run test:ci || npm run test:ci --if-present

      # Install SonarScanner CLI
      - run:
          name: Install SonarScanner
          command: |
            SCAN_VERSION="5.0.1.3006"
            curl -fsSL -o scanner.zip \
              "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-${SCAN_VERSION}-linux.zip"
            unzip -q scanner.zip
            mv "sonar-scanner-${SCAN_VERSION}-linux" sonar-scanner
            echo 'export PATH="$PWD/sonar-scanner/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV

      # Run analysis; enrich with PR info if present
      - run:
          name: SonarQube analysis
          command: |
            EXTRA_ARGS=""
            if [ -n "$CIRCLE_PULL_REQUEST" ]; then
              PR_NUMBER=$(echo "$CIRCLE_PULL_REQUEST" | awk -F/ '{print $NF}')
              EXTRA_ARGS="$EXTRA_ARGS -Dsonar.pullrequest.key=$PR_NUMBER \
                -Dsonar.pullrequest.branch=$CIRCLE_BRANCH \
                -Dsonar.pullrequest.base=main"
            fi

            sonar-scanner \
              -Dsonar.host.url="$SONAR_HOST_URL" \
              -Dsonar.login="$SONAR_TOKEN" \
              $EXTRA_ARGS

workflows:
  version: 2
  build_and_scan:
    jobs:
      - test-and-sonar